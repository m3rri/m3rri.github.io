---
title: "JPA ìƒì†ê´€ê³„ ë§¤í•‘ ì „ëµ"
date: "2022-10-24"
category: 
    - backend
    - spring
tag: 
    - jpa
    - @inheritance
    - @MappedSuperclass
---

## JPA Entity ìƒì† ê´€ê³„ ë§¤í•‘ ì „ëµ
**ğŸŒŸ ì¶œì²˜ : [ê°œë°œìì˜ ê¸°ë¡ìŠµê´€ - [JPA] ìƒì†ê´€ê³„ ë§¤í•‘ ì „ëµ(@Inheritance, @DiscriminatorColumn)](https://ict-nroo.tistory.com/128)**
### ê³µë¶€í•˜ê²Œ ëœ ë°°ê²½

> 1. Spring í”„ë¡œì íŠ¸ì— `JPA Entity`ì— ìƒì„±, ìˆ˜ì • ì‹œê°„ ê´€ë¦¬ë¥¼ ìœ„í•œ ì¹¼ëŸ¼ì´ ì¡´ì¬.
> 2. êµ­ì œí™”ë¥¼ ìœ„í•´ `UTC`ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì‚¼ì•„ BEì—ì„œ ì²˜ë¦¬í•˜ê³  í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì‹œê°„ì„ ìš”ì²­ ì‹œ FEì—ì„œ ì§€ì—­í™”í•˜ê¸° ìœ„í•´ `@PrePersist`, `@PreUpdate` ì–´ë…¸í…Œì´ì…˜ì´ ì ìš©ëœ ë©”ì†Œë“œë¥¼ ì‚¬ìš©.
> 3. í”„ë¡œì íŠ¸ì—ì„œ ê´€ë¦¬í•˜ëŠ” Entityê°€ í™•ëŒ€ë  ê²½ìš°ì—ë„ ê¸°ì¤€ ì‹œê°„ì„ UTCë¡œ ì¼ì •í•˜ê²Œ ê°€ì ¸ê°€ê¸° ìœ„í•´ì„œ ìœ„ ë©”ì†Œë“œë¥¼ ìƒì†ë°›ë„ë¡ BaseEntityë¥¼ ì„¤ê³„
> 4. ê·¸ëƒ¥ ìƒì†í•˜ë‹ˆê¹Œ `@Table` ì–´ë…¸í…Œì´ì…˜ì— ì„¤ì •í•œ í…Œì´ë¸”ì´ ì•„ë‹ˆë¼ `baseEntity`ë¼ëŠ” ì´ë¦„ì˜ í…Œì´ë¸”ì´ ìƒˆë¡œ ìƒê¸°ë©´ì„œ `DTYPE`ì´ë¼ëŠ” ì¹¼ëŸ¼ì— ì›ë˜ í…Œì´ë¸” entityëª…ì´ ì…ë ¥ ë¨

### DBì˜ `super type` :arrow_right: `sub type`ë¥¼ ë¬¼ë¦¬ ëª¨ë¸ë¡œ êµ¬í˜„í•˜ëŠ” 3ê°€ì§€ ë°©ë²•
* **Enttiy Diagram**  
![diagram](https://user-images.githubusercontent.com/94826141/197458035-7ef7dd46-e3c9-4a9b-aea0-a0d096252da2.png)
* **Entity.class**
  ```java
  @Entity
  public class BaseEntity {
      @Id
      @Column(name = "tuple_id")
      private String tupleId;
      @Column(name = "create_time")
      private Timestamp createTime;
      @Column(name = "update_time")
      private Timestamp updateTime;

      @PrePersist
      public void beforeAdd() {
          LocalDateTime ldt = LocalDateTime.ofInstant(Instant.now(), ZoneOffset.UTC);
          this.createTime = Timestamp.valueOf(ldt);
      }

      @PreUpdate
      public void beforeUpdate() {
          LocalDateTime ldt = LocalDateTime.ofInstant(Instant.now(), ZoneOffset.UTC);
          this.updateTime = Timestamp.valueOf(ldt);
      }
  }
  ```

1. `JOINED` : ê°ê°ì˜ í…Œì´ë¸”ë¡œ ìƒì„±í•œ ë’¤ ì¡°ì¸í•˜ëŠ” ì „ëµ
  * implement code
    ```java
    @Entity
    @Inheritance(strategy = InheritanceType.JOINED)
    @DiscriminatorColumn(name="DTYPE") //defaultê°€ DTYPE
    public class BaseEntity {
        @Id
        @Column(name = "tuple_id")
        private String tupleId;
        @Column(name = "create_time")
        private Timestamp createTime;
        @Column(name = "update_time")
        private Timestamp updateTime;

        @PrePersist
        ..
    }
    ```
  * `base_item`, `app_a`, `app_b`, `app_c` 4ê°œì˜ í…Œì´ë¸”ì´ ê´€ë¦¬ë˜ë©° base_item í…Œì´ë¸”ì—ë§Œ tuple_id, create_time, update_time ì˜ ë°ì´í„°ê°€ ì €ì¥ëœë‹¤. tuple_id ì¹¼ëŸ¼ì´ PKì´ì FKê°€ ëœë‹¤.
  * í•„ìˆ˜ë¡œ ì„ ì–¸í•´ì•¼ í•˜ëŠ” `@DiscriminatorColumn`ìœ¼ë¡œ ìƒì„±ëœ `DTYPE` ì¹¼ëŸ¼ì€ `sub type` í…Œì´ë¸” ì¤‘ ì–´ë–¤ ê³³ì— ë°ì´í„°ê°€ ìƒì„±ë˜ì—ˆëŠ”ì§€ ëª…ì‹œí•˜ëŠ” ì—­í• ì´ë©°, defaultëŠ” ì—”í‹°í‹° í´ë˜ìŠ¤ ì´ë¦„ì´ ì‚¬ìš©ëœë‹¤ (`appA`, `appB`, `appC`)
  * `app_a` í…Œì´ë¸”ì— ì‹ ê·œ ë°ì´í„°ë¥¼ ì €ì¥í•˜ë©´ insert queryê°€ ë‘ ë²ˆ ì‹¤í–‰ë˜ë©°, `app_a` ë°ì´í„°ë¥¼ ìƒì„± ì‹œê°„ê³¼ í•¨ê»˜ ì¡°íšŒí•˜ê³ ì í•˜ë©´ ì¡°ì¸ì´ í•„ìš”í•´ì§„ë‹¤.
  * DB ê´€ì ì—ì„œ ê°€ì¥ ì •ê·œí™”ëœ êµ¬ì¡°ì´ë©° ë©”ëª¨ë¦¬ ì¸¡ë©´ì—ì„œë„ ì‡ì ì´ ìˆë‹¤ê³  í•œë‹¤.
2. `SINGLE_TABLE` : í†µí•© í…Œì´ë¸”ë¡œ ë³€í™˜í•˜ëŠ” ë‹¨ì¼ í…Œì´ë¸” ì „ëµ
  * implement code
    ```java
    @Entity
    @Inheritance(strategy = InheritanceType.SINGLE_TABLE)
    //@DiscriminatorColumn default DTYPEìœ¼ë¡œ ì¹¼ëŸ¼ ìƒì„±í•´ì¤Œ
    public class BaseEntity {
        @Id
        @Column(name = "tuple_id")
        private String tupleId;
        @Column(name = "create_time")
        private Timestamp createTime;
        @Column(name = "update_time")
        private Timestamp updateTime;

        @PrePersist
        ...
    }
    ```
  * ê·œëª¨ë‚˜ ë³µì¡ë„ê°€ í¬ì§€ ì•Šì€ ì—”í‹°í‹°ë“¤ì˜ ê²½ìš° ëª¨ë“  ì—”í‹°í‹°ì˜ ì¹¼ëŸ¼ì„ í•œ í…Œì´ë¸”ì— ë‹¤ ì €ì¥í•˜ê³  `DTYPE`ìœ¼ë¡œ êµ¬ë¶„í•  ìˆ˜ ìˆë‹¤.
  * insert queryë„ í•œ ë²ˆì´ê³ , ì¡°ì¸ë„ í•„ìš”ê°€ ì—†ë‹¤.
  * ì§„í–‰ ì¤‘ì¸ í”„ë¡œì íŠ¸ì—ì„œëŠ” appA~appC ì— ëŒ€í•œ ì¹¼ëŸ¼ ë³€ê²½ì´ ë¹ˆë²ˆí•˜ê²Œ ì¼ì–´ë‚˜ë©° DBë¥¼ ì›¹ì—ì„œë§Œ ì ‘ê·¼í•˜ëŠ” êµ¬ì¡°ê°€ ì•„ë‹ˆê¸° ë•Œë¬¸ì— í•œ í…Œì´ë¸”ì— ëª°ì•„ë‘ê³  `DTYPE`ìœ¼ë¡œ êµ¬ë¶„í•˜ì—¬ ì‚¬ìš©í•˜ê¸°ì—ëŠ” ë¬´ë¦¬ê°€ ìˆë‹¤.
3. **`TABLE_PER_CLASS` : êµ¬í˜„ í´ë˜ìŠ¤ë§ˆë‹¤ í…Œì´ë¸”ì„ ìƒì„±í•˜ëŠ” ì „ëµ**  
  * implement code
    ```java
    @Entity
    @Inheritance(strategy = InheritanceType.TABLE_PER_CLASS)
    public class BaseEntity {
        @Id
        @Column(name = "tuple_id")
        private String tupleId;
        @Column(name = "create_time")
        private Timestamp createTime;
        @Column(name = "update_time")
        private Timestamp updateTime;

        @PrePersist
        ...
    }
    ```
  * 1ë²ˆ JOINED ì „ëµê³¼ ìœ ì‚¬í•´ë³´ì´ì§€ë§Œ `super type` ì—”í‹°í‹°ì˜ ì¹¼ëŸ¼ë“¤ì„ `sub type`ì˜ ì—”í‹°í‹° ëª¨ë‘ì— ë™ì¼í•˜ê²Œ ìƒì„±í•˜ì—¬ `app_a`, `app_b`, `app_c` ì´ 3ê°œì˜ í…Œì´ë¸”ì„ ê´€ë¦¬í•˜ê²Œ ëœë‹¤.
  * `super type` ì—”í‹°í‹°ë¡œ ì ‘ê·¼í•  ê²½ìš° `app_a`~`app_c` ë¥¼ `UNION` ì—°ì‚°ìë¥¼ ì‚¬ìš©í•˜ì—¬ ì¡°íšŒí•˜ê¸° ë•Œë¬¸ì— ì´ëŸ° ê²½ìš° ì„±ëŠ¥ì´ ì¢‹ë‹¤ê³  í•  ìˆ˜ëŠ” ì—†ë‹¤.

---

## ì–´ë…¸í…Œì´ì…˜ ë“± ì„¤ì •ê°’ ì •ë¦¬
**ğŸŒŸ ì¶œì²˜ : [victolee - [Spring JPA] ìƒì†(JOINED ì „ëµì„ ì¤‘ì‹¬ìœ¼ë¡œ)](https://victorydntmd.tistory.com/209)**
### ìƒì† ê´€ê³„ ê´€ë ¨
  * @Inheritance
    * ì–´ë–¤ ìƒì† ì „ëµì„ ì‚¬ìš©í•  ê²ƒì¸ì§€ ëª…ì‹œ
  * @DiscriminatorColumn
    * `super type` ì—”í‹°í‹°ì—ì„œ ì–´ë–¤ ì¹¼ëŸ¼ì„ ì‚¬ìš©í•˜ì—¬ `sub type` ì—”í‹°í‹°ë¥¼ êµ¬ë¶„í•  ê²ƒì¸ì§€ ëª…ì‹œ
  * @DiscriminatorValue
    * ìœ„ì˜ ì¹¼ëŸ¼ì—ì„œ `sub type` ì—”í‹°í‹° ë³„ë¡œ ê°’ì„ ê°€ì§€ë„ë¡ ì§€ì •
    * DBì—ì„œ table column valueë¡œ ë“¤ì–´ê°ˆ ê°’ì´ê¸° ë•Œë¬¸ì— ì˜ì–´/í•œê¸€ êµ¬ë¶„ ì—†ì´ ì‚¬ìš© ê°€ëŠ¥
### ê°ì²´ ë§¤í•‘ ê´€ë ¨
  * @MappedSuperclass
    * ê°ì²´ ì§€í–¥ì ìœ¼ë¡œëŠ” ìƒì† ê´€ê³„ë¥¼ ìœ ì§€í•˜ì§€ë§Œ ì‹¤ì œ êµ¬í˜„ë  entityì—ëŠ” ì˜í–¥ì„ ì£¼ì§€ ì•Šê¸° ìœ„í•´ì„œ ì‚¬ìš©
    * `super type` ì—”í‹°í‹°ì—ì„œ `@Entity` ëŒ€ì‹  `@MappedSuperclass`ë¡œ ì„ ì–¸
      * ì‹¤ì œë¡œ êµ¬í˜„ ë  ì—”í‹°í‹°ê°€ ì•„ë‹ˆê¸° ë•Œë¬¸ì— ì¶”ìƒí´ë˜ìŠ¤ë¡œ ì„ ì–¸
      * `@ID` ë¡œ ì„ ì–¸í•´ì„œ ì‚¬ìš©í•  id ì¹¼ëŸ¼ë„ í•„ìš”ì—†ìŒ
    * ìœ„ì˜ ì˜ˆì œì—ì„œ `BaseEntity`ì— ì´ ì–´ë…¸í…Œì´ì…˜ì„ ì ìš©í•˜ë©´ `BaseEntity`ì— ëŒ€í•œ ì—”í‹°í‹°ëŠ” ìƒì„±ë˜ì§€ ì•Šê³ , `TABLE_PER_CLASS` ì „ëµì„ ì ìš©í•œ ê²ƒê³¼ ìœ ì‚¬í•˜ê²Œ `BaseEntity`ì— ìˆëŠ” ì¹¼ëŸ¼ì„ ëª¨ë‘ ìì‹ `sub type` ì—”í‹°í‹°ì— í¬í•¨í•˜ì—¬ ìƒì„±
  * @AttributeOverride / @AttributeOverrides
    * `@MappedSuperclass`ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš°, ë¶€ëª¨ í´ë˜ìŠ¤ì˜ íŠ¹ì • ì¹¼ëŸ¼ì„ overrideí•˜ë ¤ê³  í•  ë•Œ ì‚¬ìš©
    ```java
    @MappedSuperclass
    public abstract class BaseEntity{
        @Column(name = "create_time")
        private Timestamp createTime;
        @Column(name = "update_time")
        private Timestamp updateTime;
    }

    @Entity
    @AttributeOverride(name="updateTime", column=@Column(name="app_a_update_time"))
    public class AppA extends BaseEntity{
      private String appAVar;
    }

    @Entity
    @AttributeOverrides({
      @AttributeOverride(name="createTime", column=@Column(name="app_b_create_time")),
      @AttributeOverride(name="updateTime", column=@Column(name="app_b_update_time")),
    })
    public class AppB extends BaseEntity{
      private String appBVar;
    }
    ```
---

### ê²°ë¡ 
* ì›ë˜ ì ìš©í•˜ë ¤ê³  í–ˆë˜ ë‚´ìš©ì€ `@MappedSuperclass`ë¥¼ ì‚¬ìš©í•˜ì—¬ ì ìš©í•˜ì˜€ìŒ
* ê¸°ì¡´ì— QueryDslë¡œ ì§ì ‘ ì¡°ì¸í•˜ì—¬ select í•˜ë„ë¡ ì„¤ê³„í–ˆë˜ ë¶€ë¶„ì„ JAVA code ìƒì—ì„œ ëª…ì‹œì ìœ¼ë¡œ ìƒì† ê´€ê³„ì— ìˆìŒì„ íŒŒì•…í•  ìˆ˜ ìˆë„ë¡ ê´€ë ¨ìˆëŠ” ì—”í‹°í‹°ë“¤ì— JOINED ì „ëµì„ ì ìš©í•˜ì˜€ìŒ
